<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Sender</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .panel {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f5f5f5;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        canvas {
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        button {
            padding: 10px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0069d9;
        }
    </style>
</head>
<body>
    <h1>WebSocket Test Sender</h1>
    
    <div class="status disconnected" id="connection-status">
        Disconnected
    </div>
    
    <div class="panel">
        <h2>Left Panel</h2>
        <canvas id="left-canvas" width="200" height="200"></canvas>
        <div>
            <button id="left-red">Red</button>
            <button id="left-green">Green</button>
            <button id="left-blue">Blue</button>
        </div>
    </div>
    
    <div class="panel">
        <h2>Center Panel</h2>
        <canvas id="center-canvas" width="200" height="200"></canvas>
        <div>
            <button id="center-red">Red</button>
            <button id="center-green">Green</button>
            <button id="center-blue">Blue</button>
        </div>
    </div>
    
    <div class="panel">
        <h2>Right Panel</h2>
        <canvas id="right-canvas" width="200" height="200"></canvas>
        <div>
            <button id="right-red">Red</button>
            <button id="right-green">Green</button>
            <button id="right-blue">Blue</button>
        </div>
    </div>
    
    <button id="send-all">Send All Panels</button>
    
    <script>
        // Canvas elements
        const leftCanvas = document.getElementById('left-canvas');
        const centerCanvas = document.getElementById('center-canvas');
        const rightCanvas = document.getElementById('right-canvas');
        
        // Status element
        const connectionStatus = document.getElementById('connection-status');
        
        // Initialize canvas contexts
        const leftCtx = leftCanvas.getContext('2d');
        const centerCtx = centerCanvas.getContext('2d');
        const rightCtx = rightCanvas.getContext('2d');
        
        // Set initial colors with patterns to make them more visible
        function drawPattern(ctx, color, size) {
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, size, size);
            
            // Add a pattern to make it more distinct
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 5;
            
            // Draw a pattern on the canvas
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(size, size);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, size);
            ctx.lineTo(size, 0);
            ctx.stroke();
            
            // Add text
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px Arial';
            ctx.fillText(color, size/2 - 30, size/2);
        }
        
        // Draw initial patterns
        drawPattern(leftCtx, '#ff0000', leftCanvas.width);
        drawPattern(centerCtx, '#00ff00', centerCanvas.width);
        drawPattern(rightCtx, '#0000ff', rightCanvas.width);
        
        // WebSocket connection
        let socket = null;
        
        function connectWebSocket() {
            socket = new WebSocket('ws://localhost:8080');
            
            socket.onopen = function() {
                connectionStatus.textContent = 'Connected';
                connectionStatus.classList.remove('disconnected');
                connectionStatus.classList.add('connected');
                
                // Send initial panel info
                sendPanelInfo('left', leftCanvas.width, leftCanvas.height);
                sendPanelInfo('center', centerCanvas.width, centerCanvas.height);
                sendPanelInfo('right', rightCanvas.width, rightCanvas.height);
            };
            
            socket.onclose = function() {
                connectionStatus.textContent = 'Disconnected - Reconnecting in 3 seconds';
                connectionStatus.classList.remove('connected');
                connectionStatus.classList.add('disconnected');
                
                // Try to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                connectionStatus.textContent = 'Error - Check console';
                connectionStatus.classList.remove('connected');
                connectionStatus.classList.add('disconnected');
            };
        }
        
        // Send panel info
        function sendPanelInfo(panelId, width, height) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            const aspectRatio = width / height;
            
            socket.send(JSON.stringify({
                type: 'panelInfo',
                panelId,
                width,
                height,
                aspectRatio
            }));
        }
        
        // Send panel frame
        function sendFrame(panelId, canvas) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            try {
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                socket.send(JSON.stringify({
                    type: 'frame',
                    panelId,
                    data: imageData,
                    width: canvas.width,
                    height: canvas.height,
                    aspectRatio: canvas.width / canvas.height,
                    timestamp: Date.now()
                }));
                
                console.log(`Sent ${panelId} frame, ${imageData.length} bytes`);
            } catch (error) {
                console.error('Error sending frame:', error);
            }
        }
        
        // Button click handlers
        document.getElementById('left-red').addEventListener('click', () => {
            leftCtx.fillStyle = '#ff0000';
            leftCtx.fillRect(0, 0, leftCanvas.width, leftCanvas.height);
            sendFrame('left', leftCanvas);
        });
        
        document.getElementById('left-green').addEventListener('click', () => {
            leftCtx.fillStyle = '#00ff00';
            leftCtx.fillRect(0, 0, leftCanvas.width, leftCanvas.height);
            sendFrame('left', leftCanvas);
        });
        
        document.getElementById('left-blue').addEventListener('click', () => {
            leftCtx.fillStyle = '#0000ff';
            leftCtx.fillRect(0, 0, leftCanvas.width, leftCanvas.height);
            sendFrame('left', leftCanvas);
        });
        
        document.getElementById('center-red').addEventListener('click', () => {
            centerCtx.fillStyle = '#ff0000';
            centerCtx.fillRect(0, 0, centerCanvas.width, centerCanvas.height);
            sendFrame('center', centerCanvas);
        });
        
        document.getElementById('center-green').addEventListener('click', () => {
            centerCtx.fillStyle = '#00ff00';
            centerCtx.fillRect(0, 0, centerCanvas.width, centerCanvas.height);
            sendFrame('center', centerCanvas);
        });
        
        document.getElementById('center-blue').addEventListener('click', () => {
            centerCtx.fillStyle = '#0000ff';
            centerCtx.fillRect(0, 0, centerCanvas.width, centerCanvas.height);
            sendFrame('center', centerCanvas);
        });
        
        document.getElementById('right-red').addEventListener('click', () => {
            rightCtx.fillStyle = '#ff0000';
            rightCtx.fillRect(0, 0, rightCanvas.width, rightCanvas.height);
            sendFrame('right', rightCanvas);
        });
        
        document.getElementById('right-green').addEventListener('click', () => {
            rightCtx.fillStyle = '#00ff00';
            rightCtx.fillRect(0, 0, rightCanvas.width, rightCanvas.height);
            sendFrame('right', rightCanvas);
        });
        
        document.getElementById('right-blue').addEventListener('click', () => {
            rightCtx.fillStyle = '#0000ff';
            rightCtx.fillRect(0, 0, rightCanvas.width, rightCanvas.height);
            sendFrame('right', rightCanvas);
        });
        
        document.getElementById('send-all').addEventListener('click', () => {
            sendFrame('left', leftCanvas);
            sendFrame('center', centerCanvas);
            sendFrame('right', rightCanvas);
        });
        
        // Connect when page loads
        connectWebSocket();

        document.getElementById('sendBtn').addEventListener('click', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log('Sending canvas data...');
                
                // Get data from each canvas with high quality
                try {
                    const leftData = leftCanvas.toDataURL('image/png', 1.0);
                    const centerData = centerCanvas.toDataURL('image/png', 1.0);
                    const rightData = rightCanvas.toDataURL('image/png', 1.0);
                    
                    // Log data length for debugging
                    console.log(`Left data length: ${leftData.length}`);
                    console.log(`Center data length: ${centerData.length}`);
                    console.log(`Right data length: ${rightData.length}`);
                    
                    // Send each panel data separately
                    socket.send(JSON.stringify({
                        type: 'frame',
                        panelId: 'left',
                        data: leftData
                    }));
                    
                    socket.send(JSON.stringify({
                        type: 'frame',
                        panelId: 'center',
                        data: centerData
                    }));
                    
                    socket.send(JSON.stringify({
                        type: 'frame',
                        panelId: 'right',
                        data: rightData
                    }));
                    
                    console.log('Sent all canvas data successfully');
                    document.getElementById('status').textContent = 'Sent data: ' + new Date().toLocaleTimeString();
                } catch (error) {
                    console.error('Error sending canvas data:', error);
                    document.getElementById('status').textContent = 'Error: ' + error.message;
                }
            } else {
                console.error('WebSocket not connected');
                document.getElementById('status').textContent = 'Error: WebSocket not connected';
            }
        });
    </script>
</body>
</html> 